<!DOCTYPE html>
<html>
<body>
<h2>Receiver (View Only)</h2>

<button onclick="leaveCall()">Leave</button>

<br><br>

<!-- Receiver only displays remote video -->
<video id="remote" autoplay playsinline muted style="width:500px; background:black;"></video>

<script>
const ws = new WebSocket("ws://localhost:3001");
const roomId = "92732dc1-0082-4105-9a5d-bde42d931932";

let pc = null;

// ICE buffer
let pendingCandidates = [];

ws.onopen = () => {
  ws.send(JSON.stringify({ type: "join-room", roomId }));
  console.log("Receiver joined room", roomId);
};

ws.onmessage = async (msg) => {
  const data = JSON.parse(msg.data);
  console.log("Receiver received:", data);

  if (data.type === "offer") {
    await handleOffer(data.payload);
  }

  if (data.type === "ice-candidate") {
    if (pc && pc.remoteDescription) {
      await pc.addIceCandidate(data.payload);
    } else {
      pendingCandidates.push(data.payload);
    }
  }
};

async function handleOffer(offer) {
  pc = createPeerConnection();

  // Receiver does NOT open webcam
  await pc.setRemoteDescription(offer);

  // apply pending ICE
  for (const cand of pendingCandidates) {
    await pc.addIceCandidate(cand);
  }
  pendingCandidates = [];

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);

  ws.send(JSON.stringify({
    type: "answer",
    roomId,
    payload: answer
  }));
}

function createPeerConnection() {
  const pc = new RTCPeerConnection();

  pc.ontrack = (e) => {
    console.log("Receiver got remote track");
    const remoteVideo = document.getElementById("remote");
    remoteVideo.srcObject = e.streams[0];
    remoteVideo.play().catch(err => console.log("Remote autoplay blocked:", err));
  };

  pc.onicecandidate = (e) => {
    if (e.candidate) {
      ws.send(JSON.stringify({
        type: "ice-candidate",
        roomId,
        payload: e.candidate
      }));
    }
  };

  return pc;
}

function leaveCall() {
  if (pc) pc.close();
  ws.close();
}
</script>

</body>
</html>
